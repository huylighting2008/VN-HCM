-- ===== SERVICES =====
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- ===== TOGGLE =====
local ENABLED = true

-- ===== GUI =====
local gui = Instance.new("ScreenGui", pGui)
gui.Name = "AutoQTE_GUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 180, 0, 40)
frame.Position = UDim2.new(0.5, -90, 0.85, 0)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

local label = Instance.new("TextLabel", frame)
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Font = Enum.Font.GothamBold
label.TextSize = 14
label.TextColor3 = Color3.fromRGB(0, 255, 120)
label.Text = "üü¢ AUTO QTE: ON"

-- ALT PH·∫¢I b·∫≠t / t·∫Øt
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.RightAlt then
        ENABLED = not ENABLED
        if ENABLED then
            label.Text = "üü¢ AUTO QTE: ON"
            label.TextColor3 = Color3.fromRGB(0, 255, 120)
        else
            label.Text = "üî¥ AUTO QTE: OFF"
            label.TextColor3 = Color3.fromRGB(255, 80, 80)
        end
    end
end)

-- ===== H√ÄM NH·∫§N PH√çM =====
local function pressKey(keyName)
    local keyCode = Enum.KeyCode[keyName]
    if keyCode then
        VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
        task.wait(0.04)
        VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
    end
end

-- ===== OPTIMIZED QTE LOGIC =====
local lastScan = 0
local SCAN_INTERVAL = 0.08      -- qu√©t UI ~12 l·∫ßn/gi√¢y
local PRESS_INTERVAL = 0.12     -- b·∫•m ~8 l·∫ßn/gi√¢y
local activeQTE = {}            -- [TextLabel] = lastPressTime
local hooked = {}               -- tr√°nh hook nhi·ªÅu l·∫ßn

RunService.Heartbeat:Connect(function()
    if not ENABLED then return end

    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now

    for _, gui in ipairs(pGui:GetChildren()) do
        if gui:IsA("ScreenGui") and gui.Enabled then
            local screenSize = gui.AbsoluteSize

            for _, element in ipairs(gui:GetDescendants()) do
                if element:IsA("TextLabel") and element.Visible then
                    local key = element.Text:upper()
                    if #key == 1 and key:match("%a") then
                        local pos = element.AbsolutePosition

                        -- ch·ªâ x·ª≠ l√Ω QTE g·∫ßn gi·ªØa m√†n h√¨nh
                        if pos.Y > screenSize.Y * 0.35 and pos.Y < screenSize.Y * 0.65 then
                            local last = activeQTE[element] or 0
                            if now - last >= PRESS_INTERVAL then
                                activeQTE[element] = now
                                pressKey(key)
                            end

                            -- QTE bi·∫øn m·∫•t ‚Üí d·ª´ng
                            if not hooked[element] then
                                hooked[element] = true
                                element.AncestryChanged:Once(function(_, parent)
                                    if not parent then
                                        activeQTE[element] = nil
                                        hooked[element] = nil
                                    end
                                end)
                            end
                        end
                    end
                end
            end
        end
    end
end)

print("[AUTO QTE] Loaded | RightAlt to toggle")
