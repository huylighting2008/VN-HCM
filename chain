-- AUTO PARRY QTE - STABLE + AUTO IDLE (FIXED)

local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ===== CONFIG =====
local ENABLED = true
local CENTER_RADIUS = 260
-- ==================

-- lÆ°u QTE Ä‘Ã£ xá»­ lÃ½
local handledQTE = {}

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "AutoParryStatus"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 170, 0, 40)
frame.Position = UDim2.new(0.5, -85, 0.8, 0)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local label = Instance.new("TextLabel", frame)
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Font = Enum.Font.GothamBold
label.TextSize = 14
label.Text = "âšª Auto Parry: IDLE"
label.TextColor3 = Color3.fromRGB(180, 180, 180)
-- ======================================

local function setStatus(active)
    if active then
        label.Text = "ðŸŸ¢ Auto Parry: ACTIVE"
        label.TextColor3 = Color3.fromRGB(0, 255, 120)
    else
        label.Text = "âšª Auto Parry: IDLE"
        label.TextColor3 = Color3.fromRGB(180, 180, 180)
    end
end

local function isValidKey(text)
    return typeof(text) == "string"
        and #text == 1
        and text:match("%a")
end

local function pressKey(key)
    key = key:upper()
    VirtualInputManager:SendKeyEvent(true, key, false, game)
    task.wait()
    VirtualInputManager:SendKeyEvent(false, key, false, game)
end

local function getCenter()
    local v = Camera.ViewportSize
    return Vector2.new(v.X / 2, v.Y / 2)
end

RunService.RenderStepped:Connect(function()
    if not ENABLED then return end

    local center = getCenter()
    local anyQTE = false

    for _, v in ipairs(playerGui:GetDescendants()) do
        if v:IsA("TextLabel")
            and v.Visible
            and isValidKey(v.Text)
            and v.AbsoluteSize.X >= 26
        then
            local pos = v.AbsolutePosition + (v.AbsoluteSize / 2)
            local dist = (pos - center).Magnitude

            if dist <= CENTER_RADIUS then
                anyQTE = true
                setStatus(true)

                if not handledQTE[v] then
                    handledQTE[v] = true
                    pressKey(v.Text)
                end
            end
        end
    end

    -- â„ KhÃ´ng cÃ²n QTE â†’ reset & idle
    if not anyQTE then
        handledQTE = {}
        setStatus(false)
    end
end)
