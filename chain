-- AUTO PARRY QTE - SMART ACTIVE / IDLE

local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ===== CONFIG =====
local ENABLED = true
local CENTER_RADIUS = 260
-- ==================

-- LÆ°u QTE Ä‘Ã£ xá»­ lÃ½
local handledQTE = {}

-- ================= GUI =================
local gui = Instance.new("ScreenGui", playerGui)
gui.Name = "AutoParryStatus"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 160, 0, 40)
frame.Position = UDim2.new(0.5, -80, 0.8, 0)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local label = Instance.new("TextLabel", frame)
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Font = Enum.Font.GothamBold
label.TextSize = 14
-- ======================================

local function setStatus(active)
    if active then
        label.Text = "ðŸŸ¢ Auto Parry: ACTIVE"
        label.TextColor3 = Color3.fromRGB(0, 255, 120)
    else
        label.Text = "âšª Auto Parry: IDLE"
        label.TextColor3 = Color3.fromRGB(180, 180, 180)
    end
end

setStatus(false)

local function isValidKey(text)
    return typeof(text) == "string"
        and #text == 1
        and text:match("%a")
end

local function pressKey(key)
    key = key:upper()
    VirtualInputManager:SendKeyEvent(true, key, false, game)
    task.wait()
    VirtualInputManager:SendKeyEvent(false, key, false, game)
end

local function getCenter()
    local v = Camera.ViewportSize
    return Vector2.new(v.X / 2, v.Y / 2)
end

RunService.RenderStepped:Connect(function()
    if not ENABLED then return end

    local center = getCenter()
    local foundQTE = false

    for _, v in ipairs(playerGui:GetDescendants()) do
        if v:IsA("TextLabel")
            and v.Visible
            and isValidKey(v.Text)
            and not handledQTE[v]
            and v.AbsoluteSize.X >= 26
        then
            local pos = v.AbsolutePosition + (v.AbsoluteSize / 2)
            local dist = (pos - center).Magnitude

            if dist <= CENTER_RADIUS then
                foundQTE = true
                handledQTE[v] = true
                setStatus(true)
                pressKey(v.Text)

                -- â™» Reset khi QTE biáº¿n máº¥t
                v:GetPropertyChangedSignal("Visible"):Once(function()
                    handledQTE[v] = nil
                end)

                v.AncestryChanged:Once(function()
                    handledQTE[v] = nil
                end)

                break
            end
        end
    end

    if not foundQTE then
        setStatus(false)
    end
end)
